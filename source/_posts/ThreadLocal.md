---
title: ThreadLocal
date: 2025-12-02 16:49:00
excerpt: ThreadLocalè¯¦ç»†ä»‹ç»ã€‚
---



`ThreadLocal` æ˜¯ Java é‡Œéå¸¸ä¼˜é›…ä½†åˆå®¹æ˜“è¢«å¿½è§†çš„ä¸€ä¸ªå·¥å…·ï¼Œ**ç”¨æ¥ç»™æ¯ä¸ªçº¿ç¨‹å­˜ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬**ã€‚

ä½ å¯ä»¥æŠŠå®ƒå½“æˆï¼š

âœ” **çº¿ç¨‹å†…éƒ¨è‡ªå·±çš„å°ä»“åº“**
 âœ” **çº¿ç¨‹çº§åˆ«çš„å…¨å±€å˜é‡å®¹å™¨**

------

------

# ğŸ”µ 1. ç”¨ä¸€å¥å¤§ç™½è¯è§£é‡Š

> ThreadLocal è®©æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€ä»½æ•°æ®ï¼Œäº’ä¸å¹²æ‰°ã€‚

å°±åƒ æ¯ä¸ªå­¦ç”Ÿä¸€å¼ è¯•å· â€”â€”
 ä½ åœ¨è‡ªå·±å·å­ä¸Šå†™ç­”æ¡ˆï¼Œå¹¶ä¸ä¼šå½±å“åˆ«äººå·å­ã€‚

------

------

# ğŸ”µ 2. å®ƒç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å…±äº«ä¸€ä¸ªå˜é‡ï¼Œä¼šå‡ºç°ï¼š

âŒ æ•°æ®é”™ä¹±
 âŒ å¹¶å‘è¦†ç›–
 âŒ å–ä¸åˆ°æ­£ç¡®çº¿ç¨‹çš„ä¸Šä¸‹æ–‡

ThreadLocal çš„ä½œç”¨å°±æ˜¯ï¼š

âœ” æ¯ä¸ªçº¿ç¨‹å­˜è‡ªå·±çš„å€¼
 âœ” äº’ä¸å½±å“
 âœ” ä¸éœ€è¦åŠ é”ä¹Ÿèƒ½ç»å¯¹çº¿ç¨‹å®‰å…¨

------

------

# ğŸ”µ 3. ç”¨ ThreadLocal åšä»€ä¹ˆï¼Ÿ

æœ€å¸¸è§ç”¨é€”ï¼ˆç‰¹åˆ«æ˜¯ä½ åšåå°é¡¹ç›®æ—¶ä¸€å®šç”¨åˆ°ï¼‰ï¼š

### âœ” å­˜å‚¨ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆSpring æ‹¦æˆªå™¨é‡Œè¶…å¸¸ç”¨ï¼‰

```java
public class UserHolder {
    private static final ThreadLocal<UserDTO> tl = new ThreadLocal<>();

    public static void set(UserDTO user){ tl.set(user); }

    public static UserDTO get(){ return tl.get(); }

    public static void remove(){ tl.remove(); }
}
```

è¿™æ · Controllerã€Service éšæ—¶å¯ä»¥æ‹¿åˆ°å½“å‰ç”¨æˆ·ï¼š

```java
UserDTO user = UserHolder.get();
```

------

------

### âœ” äº‹åŠ¡ID / trace ID / æ—¥å¿—è·Ÿè¸ª

```java
ThreadLocal<String> traceId = new ThreadLocal<>();
traceId.set("req-12345");
```

------

------

### âœ” æ—¥æœŸè§£æå™¨ï¼ˆé¿å…çº¿ç¨‹ä¸å®‰å…¨çš„ SimpleDateFormatï¼‰

```java
private static final ThreadLocal<SimpleDateFormat> sdf =
        ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyy-MM-dd"));
```

------

------

# ğŸ”µ 4. ThreadLocal çš„æ ¸å¿ƒ API

| æ–¹æ³•       | ä½œç”¨                        |
| ---------- | --------------------------- |
| `set()`    | è®¾ç½®å½“å‰çº¿ç¨‹çš„å€¼            |
| `get()`    | è·å–è¯¥çº¿ç¨‹çš„å€¼              |
| `remove()` | æ¸…é™¤å­˜å‚¨ï¼ˆéå¸¸é‡è¦ é˜²æ³„éœ²ï¼‰ |

æ¨èå†™æ³•ï¼š

```java
private static ThreadLocal<User> tl = new ThreadLocal<>();

tl.set(user);    // ç»‘å®š
...
tl.get();        // è·å–
...
tl.remove();     // æ¸…é™¤ é¿å…å†…å­˜æ³„æ¼
```

------

------

# ğŸ”µ 5. å†…éƒ¨ç»“æ„æ€ä¹ˆç†è§£ï¼Ÿï¼ˆç®€å•ä½†é‡è¦ï¼‰

ThreadLocal è‡ªå·±ä¸å­˜å€¼
 âœ” çœŸæ­£çš„æ•°æ®å­˜åœ¨çº¿ç¨‹ï¼ˆThreadï¼‰çš„ ThreadLocalMap é‡Œ
 âœ” ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ª mapï¼Œkey æ˜¯ ThreadLocal å¯¹è±¡

ç†è§£ç»“æ„ï¼š

```
çº¿ç¨‹å¯¹è±¡ Thread
 â””â”€â”€ ThreadLocalMap
      â”œâ”€â”€ key = ThreadLocal å¯¹è±¡A â†’ value=æ•°æ®A
      â””â”€â”€ key = ThreadLocal å¯¹è±¡B â†’ value=æ•°æ®B
```

æ‰€ä»¥æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ä¸€ä»½æ•°æ®ï¼Œäº’ä¸å½±å“ã€‚

------

------

# ğŸ”¥ 6. å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼š**ä¸ remove**

ThreadLocal çš„ entry key æ˜¯å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ï¼Œ

â¡ è‹¥ä½ ä¸ removeï¼š

âœ” key ä¼šè¢« GC å›æ”¶
 âœ” value å­˜åœ¨çº¿ç¨‹é‡Œ
 âœ” å¯¼è‡´ value æ°¸è¿œå¾—ä¸åˆ°æ¸…ç†
 âœ” å°±å« ThreadLocal **å†…å­˜æ³„æ¼**

### æ­£ç¡®å†™æ³•

âœ” åœ¨ finally æˆ–æ‹¦æˆªå™¨ `afterCompletion()` ä¸­ remove

```java
try{
    tl.set(user);
    ...
}finally {
    tl.remove();
}
```

åœ¨ Spring æ‹¦æˆªå™¨ä¸­ï¼š

```java
@Override
public void afterCompletion(...) {
    UserHolder.remove(); // é‡Šæ”¾çº¿ç¨‹å†…å­˜
}
```

âš  è¿™æ˜¯ä½ é¡¹ç›®å¿…é¡»åšçš„ï¼

------

------

# ğŸ”µ 7. ThreadLocal vs å…¨å±€å˜é‡ vs å‚æ•°ä¼ é€’

| æ–¹å¼         | æ˜¯å¦çº¿ç¨‹å®‰å…¨ | æ˜¯å¦æ¯çº¿ç¨‹ç‹¬ç«‹ | ä¾µå…¥æ€§               |
| ------------ | ------------ | -------------- | -------------------- |
| å…¨å±€å˜é‡     | âŒ            | âŒ              | ä½                   |
| æ–¹æ³•å‚æ•°ä¼ é€’ | âœ”            | âœ”              | é«˜ï¼ˆæ¯å±‚éƒ½è¦ä¼ ï¼‰     |
| ThreadLocal  | âœ”            | âœ”              | ä½ï¼ˆæ— éœ€æ”¹æ–¹æ³•ç­¾åï¼‰ |

â¡ æ‰€ä»¥ ThreadLocal ç‰¹åˆ«é€‚åˆ **è·¨å±‚ä¼ é€’ç”¨æˆ·ä¸Šä¸‹æ–‡ / traceId**

------

------

# ğŸ”µ 8. ç”¨ ThreadLocal çš„æœ€ä½³æ¨¡å¼

### â‘  å°è£…å·¥å…·ç±» UserContext / UserHolder

### â‘¡ æ‹¦æˆªå™¨é‡Œ set()

### â‘¢ Controller / Service é‡Œéšå–éšç”¨

### â‘£ æ‹¦æˆªå™¨ afterCompletion() é‡Œ remove()

âœ” ä½ çš„ SpringCloud / Web é¡¹ç›®ç™»å½•æ€å°±æ˜¯è¿™ä¸ªç”¨æ³•

------

------

# ğŸ”¥ 9. å’Œ AOP / Filter æ­é…æ•ˆæœæ›´å¥½

ç‰¹åˆ«é€‚åˆï¼š

âœ” JWT è§£æ
 âœ” ç™»å½•é‰´æƒ
 âœ” æ•°æ®æƒé™éš”ç¦»
 âœ” é“¾è·¯è¿½è¸ª traceId

------

------

# ğŸŸ£ æ€»ç»“

ğŸ‘‰ ThreadLocal = æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰å­˜å‚¨å®¹å™¨
 ğŸ‘‰ ä½¿ç”¨æ—¶ä¸€å®šè®°å¾— remove é˜²æ­¢å†…å­˜æ³„æ¼
 ğŸ‘‰ ç”¨äºå­˜ç™»å½•ç”¨æˆ·ã€ä¸Šä¸‹æ–‡ã€traceId æ˜¯æœ€å¸¸è§åœºæ™¯

------

------

