---
title: Spring AMQP ä¸‹ Publisher Confirms å’Œ Publisher Returns çš„å¯¹æ¯”
date: 2025-11-05 17:00:00
# tags: [Java, Stream, å‡½æ•°å¼ç¼–ç¨‹]
# categories: [ç¼–ç¨‹æŠ€æœ¯]
excerpt: Spring AMQP ä¸‹ Publisher Confirms å’Œ Publisher Returns çš„å¯¹æ¯”ã€‚
---



------


`ReturnCallback` å’Œ `ConfirmCallback` æ˜¯åœ¨ä½¿ç”¨ Spring AMQPï¼ˆSpring Data RabbitMQï¼‰æ¡†æ¶æ—¶ï¼Œå¯¹æ ‡å‡† RabbitMQ å®¢æˆ·ç«¯çš„ `ReturnListener` å’Œ `ConfirmListener` æœºåˆ¶è¿›è¡Œçš„é«˜çº§å°è£…ã€‚

å®ƒä»¬æ˜¯ Spring Boot/Spring Cloud åº”ç”¨ä¸­å®ç°æ¶ˆæ¯å¯é æ€§çš„**æ ¸å¿ƒæ¥å£**ã€‚

------



### 1. ğŸ”„ ConfirmCallback (å¯¹åº” Publisher Confirms)

`ConfirmCallback` æ¥å£ç”¨äºå¤„ç† **ç”Ÿäº§è€…ç¡®è®¤ï¼ˆPublisher Confirmsï¼‰** çš„ç»“æœã€‚å®ƒå‘Šè¯‰ç”Ÿäº§è€…æ¶ˆæ¯æ˜¯å¦å·²è¢« RabbitMQ Broker æˆåŠŸæ¥æ”¶ã€‚

#### å…³æ³¨ç‚¹

- **å…³æ³¨é˜¶æ®µï¼š** ç”Ÿäº§è€… $\rightarrow$ Brokerã€‚
- **å¦‚ä½•ä½¿ç”¨ï¼š** å°†è¯¥å›è°ƒå®ç°ç±»åŠ åˆ° `correlationData` çš„`future`ä¸­ï¼ˆæ¯æ¬¡å‘æ¶ˆæ¯éƒ½è¦æŒ‡å®šï¼Œå› æ­¤ä¸€èˆ¬æ˜¯å†™åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼‰ã€‚
- **æ ¸å¿ƒé€»è¾‘ï¼š**
  - å¦‚æœ `ack` ä¸º `true`ï¼šè¡¨ç¤ºæ¶ˆæ¯å®‰å…¨åˆ°è¾¾ Brokerï¼Œå¯ä»¥ä»é‡å‘é˜Ÿåˆ—æˆ–å†…å­˜ä¸­ç§»é™¤è¿™æ¡æ¶ˆæ¯ã€‚
  - å¦‚æœ `ack` ä¸º `false`ï¼šè¡¨ç¤ºæ¶ˆæ¯æœªèƒ½è¢« Broker æ¥æ”¶ï¼ˆé€šå¸¸æ˜¯ç½‘ç»œé—®é¢˜æˆ– Broker å†…éƒ¨é”™è¯¯ï¼‰ï¼Œéœ€è¦æ ¹æ® `correlationData` å°è¯•**é‡å‘**æˆ–è®°å½•å¤±è´¥æ—¥å¿—ã€‚

------



### 2. â†©ï¸ ReturnCallback (å¯¹åº” Publisher Returns)

`ReturnCallback` æ¥å£ç”¨äºå¤„ç† **ç”Ÿäº§è€…è¿”å›ï¼ˆPublisher Returnsï¼‰** çš„äº‹ä»¶ã€‚å®ƒå‘Šè¯‰ç”Ÿäº§è€…æ¶ˆæ¯è™½ç„¶è¢« Broker æ¥æ”¶äº†ï¼Œä½† Exchange æ— æ³•å°†å…¶è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ã€‚

#### å…³æ³¨ç‚¹

- **å…³æ³¨é˜¶æ®µï¼š** Exchange $\rightarrow$ Queueã€‚
- **å¦‚ä½•ä½¿ç”¨ï¼š** å°†è¯¥å›è°ƒå®ç°ç±»æ³¨å…¥åˆ° Spring çš„ `RabbitTemplate` ä¸­ï¼ˆåªèƒ½é…ç½®ä¸€ä¸ªï¼Œé…ç½®ç±»ä¸­é…ç½®ï¼‰
- **æ ¸å¿ƒé€»è¾‘ï¼š**
  - è¯¥å›è°ƒæ–¹æ³•è¢«è°ƒç”¨ï¼Œæ„å‘³ç€**æ¶ˆæ¯å·²ä¸¢å¤±**ï¼ˆæ— æ³•è¢«æ¶ˆè´¹è€…è·å–ï¼‰ã€‚
  - ç”Ÿäº§è€…åº”æ£€æŸ¥ `replyText` å’Œ `routingKey`ï¼Œé€šå¸¸éœ€è¦è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œç„¶åå°† `message` **é‡æ–°å‘é€**åˆ°å¤‡ç”¨ Exchange æˆ–äººå·¥å¤„ç†é˜Ÿåˆ—ï¼Œä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚

------



### ğŸ“Š æ€»ç»“å¯¹æ¯” (Spring AMQP è§†è§’)

| **ç‰¹æ€§**     | **ConfirmCallback**               | **ReturnCallback**                                    |
| ------------ | --------------------------------- | ----------------------------------------------------- |
| **åº•å±‚å¯¹åº”** | Publisher Confirms (Ack/Nack)     | Publisher Returns                                     |
| **ä½•æ—¶è§¦å‘** | æ¶ˆæ¯è¢« **Broker æ¥æ”¶/æ‹’ç»** æ—¶    | æ¶ˆæ¯è¢« **Exchange æ¥æ”¶** ä¸” **æ— æ³•è·¯ç”±** åˆ°ä»»ä½•é˜Ÿåˆ—æ—¶ |
| **å…³æ³¨é‡ç‚¹** | **æ¥æ”¶çš„å®‰å…¨æ€§**                  | **è·¯ç”±çš„å‡†ç¡®æ€§**                                      |
| **æ ¸å¿ƒå‚æ•°** | `ack` (å¸ƒå°”å€¼) å’Œ `cause(reason)` | `message` å’Œ `replyCode`/`replyText`                  |
| **å…¸å‹å¤„ç†** | Ack: æ¸…é™¤è®°å½•ï¼›Nack: **é‡å‘**æ¶ˆæ¯ | è®°å½•æ—¥å¿—å¹¶å†³å®šæ˜¯å¦ **é‡æ–°è·¯ç”±**                       |

**é‡è¦æç¤ºï¼š**

åœ¨ Spring AMQP ä¸­ï¼Œè¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°æ˜¯å®ç°**ç«¯åˆ°ç«¯å¯é æ€§**çš„é»„é‡‘æ­æ¡£ã€‚å®ƒä»¬ä½¿ä¸šåŠ¡é€»è¾‘èƒ½å¤Ÿæ¸…æ™°åœ°å¤„ç†æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­çš„æ‰€æœ‰å¼‚å¸¸æƒ…å†µã€‚

**ä½¿ç”¨æ­¥éª¤**ï¼š

1.![image-20251105162446530](https://ye-hai.oss-cn-shenzhen.aliyuncs.com/typora/image-20251105162446530.png)

2.![image-20251105162521843](https://ye-hai.oss-cn-shenzhen.aliyuncs.com/typora/image-20251105162521843.png)

3.

![image-20251105162550437](https://ye-hai.oss-cn-shenzhen.aliyuncs.com/typora/image-20251105162550437.png)



ï¼**ä½†æ˜¯ä»¥ä¸Šæœºåˆ¶éƒ½ä¸€èˆ¬ä¸ä¼šå¼€å¯**